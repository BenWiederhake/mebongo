<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8">
<style>
.inb{position:absolute;opacity:0%;}
.inb~label{background-image: url("square_black.png");background-size:contain;
  width:60px;height:60px;display:block;}
.inb:checked~label{background-image:url("square_white.png");}
.tpr{width:30px;height: 30px;}
.int{display:inline-block;vertical-align:middle;margin-top:3px;margin-bottom:3px;}
.bo{width:60px;height:60px;}
.c254{background-image:url("square_white.png");background-size:contain;}
.c255{background-image:url("square_black.png");background-size:contain;}
.c0{background-image:url("square_col_00.png");background-size:contain;}
.c1{background-image:url("square_col_01.png");background-size:contain;}
.c2{background-image:url("square_col_02.png");background-size:contain;}
.c3{background-image:url("square_col_03.png");background-size:contain;}
.c4{background-image:url("square_col_04.png");background-size:contain;}
.c5{background-image:url("square_col_05.png");background-size:contain;}
.c6{background-image:url("square_col_06.png");background-size:contain;}
.c7{background-image:url("square_col_07.png");background-size:contain;}
.c8{background-image:url("square_col_08.png");background-size:contain;}
.c9{background-image:url("square_col_09.png");background-size:contain;}
.c10{background-image:url("square_col_10.png");background-size:contain;}
.c11{background-image:url("square_col_11.png");background-size:contain;}
table,tr,td{padding:0;border-spacing:0;}
</style>
</head>
<body><center>

<h1>Mebongo</h1>

<table>
<tr>
  <th id="input-tiles-label">Loading …</th>
  <th style="width: 3rem;"></th>
  <th id="input-board-label">Loading …</th>
  <th style="width: 3rem;"></th>
  <th><span id="output-label">Loading …</span><br/><span id="output-label-small" class="tiny">Loading …</span></th>
</tr>
<tr></tr>
<td>

<table>
<tr>
<td><div><input type="checkbox" id="t0"><label class="int" for="tile_0"><table>
<tr><td class="tpr c0"></td><td class="tpr c0"></td></tr>
<tr><td class="tpr c0"></td><td class="tpr c0"></td></tr>
</table></label></div></td>
<td><div><input type="checkbox" id="t1"><label class="int" for="tile_1"><table>
<tr><td class="tpr c1"></td></td><td class="tpr c1"></td></tr>
</table></label></div></td>
</tr><tr>
<td><div><input type="checkbox" id="t2"><label class="int" for="tile_2"><table>
<tr><td class="tpr c2"></td><td class="tpr c2"></td><td class="tpr c2"></td></tr>
</table></label></div></td>
<td><div><input type="checkbox" id="t3"><label class="int" for="tile_3"><table>
<tr><td class="tpr c3"></td><td class="tpr c3"></td><td class="tpr c3"></td><td class="tpr c3"></td></tr>
</table></label></div></td>
</tr><tr>
<td><div><input type="checkbox" id="t4"><label class="int" for="tile_4"><table>
<tr><td class="tpr c4"></td><td class="tpr c4"></td></tr>
<tr><td class="tpr"></td><td class="tpr c4"></td></tr>
</table></label></div></td>
<td><div><input type="checkbox" id="t5"><label class="int" for="tile_5"><table>
<tr><td class="tpr c5"></td><td class="tpr c5"></td><td class="tpr c5"></td></tr>
<tr><td class="tpr"></td><td class="tpr c5"></td><td class="tpr"></td></tr>
</table></label></div></td>
</tr><tr>
<td><div><input type="checkbox" id="t6"><label class="int" for="tile_6"><table>
<tr><td class="tpr c6"></td><td class="tpr c6"></td><td class="tpr"></td></tr>
<tr><td class="tpr"></td><td class="tpr c6"></td><td class="tpr c6"></td></tr>
</table></label></div></td>
<td><div><input type="checkbox" id="t7"><label class="int" for="tile_7"><table>
<tr><td class="tpr c7"></td><td class="tpr c7"></td><td class="tpr"></td></tr>
<tr><td class="tpr"></td><td class="tpr c7"></td><td class="tpr"></td></tr>
<tr><td class="tpr"></td><td class="tpr c7"></td><td class="tpr c7"></td></tr>
</table></label></div></td>
</tr><tr>
<td><div><input type="checkbox" id="t8"><label class="int" for="tile_8"><table>
<tr><td class="tpr c8"></td><td class="tpr c8"></td><td class="tpr c8"></td></tr>
<tr><td class="tpr c8"></td><td class="tpr"></td><td class="tpr"></td></tr>
</table></label></div></td>
<td><div><input type="checkbox" id="t9"><label class="int" for="tile_9"><table>
<tr><td class="tpr c9"></td><td class="tpr c9"></td><td class="tpr c9"><td class="tpr c9"></td></tr>
<tr><td class="tpr c9"></td><td class="tpr"></td><td class="tpr"><td class="tpr"></td></tr>
</table></label></div></td>
</tr><tr>
<td><div><input type="checkbox" id="t10"><label class="int" for="tile_10"><table>
<tr><td class="tpr c10"></td><td class="tpr c10"></td><td class="tpr c10"><td class="tpr c10"></td></tr>
<tr><td class="tpr"></td><td class="tpr c10"></td><td class="tpr"><td class="tpr"></td></tr>
</table></label></div></td>
<td><div><input type="checkbox" id="t11"><label class="int" for="tile_11"><table>
<tr><td class="tpr c11"></td><td class="tpr c11"></td><td class="tpr c11"></td></tr>
<tr><td class="tpr c11"></td><td class="tpr c11"></td><td class="tpr"></td></tr>
</table></label></div></td>
</tr>
</table>

</td><td><center>+</center></td><td>

<table>
<tr>
<td><div><input type="checkbox" id="bi00" class="inb"><label for="bi00"></label></div></td>
<td><div><input type="checkbox" id="bi10" class="inb"><label for="bi10"></label></div></td>
<td><div><input type="checkbox" id="bi20" class="inb"><label for="bi20"></label></div></td>
<td><div><input type="checkbox" id="bi30" class="inb"><label for="bi30"></label></div></td>
<td><div><input type="checkbox" id="bi40" class="inb"><label for="bi40"></label></div></td>
</tr>
<tr>
<td><div><input type="checkbox" id="bi01" class="inb"><label for="bi01"></label></div></td>
<td><div><input type="checkbox" id="bi11" class="inb"><label for="bi11"></label></div></td>
<td><div><input type="checkbox" id="bi21" class="inb"><label for="bi21"></label></div></td>
<td><div><input type="checkbox" id="bi31" class="inb"><label for="bi31"></label></div></td>
<td><div><input type="checkbox" id="bi41" class="inb"><label for="bi41"></label></div></td>
</tr>
<tr>
<td><div><input type="checkbox" id="bi02" class="inb"><label for="bi02"></label></div></td>
<td><div><input type="checkbox" id="bi12" class="inb"><label for="bi12"></label></div></td>
<td><div><input type="checkbox" id="bi22" class="inb"><label for="bi22"></label></div></td>
<td><div><input type="checkbox" id="bi32" class="inb"><label for="bi32"></label></div></td>
<td><div><input type="checkbox" id="bi42" class="inb"><label for="bi42"></label></div></td>
</tr>
<tr>
<td><div><input type="checkbox" id="bi03" class="inb"><label for="bi03"></label></div></td>
<td><div><input type="checkbox" id="bi13" class="inb"><label for="bi13"></label></div></td>
<td><div><input type="checkbox" id="bi23" class="inb"><label for="bi23"></label></div></td>
<td><div><input type="checkbox" id="bi33" class="inb"><label for="bi33"></label></div></td>
<td><div><input type="checkbox" id="bi43" class="inb"><label for="bi43"></label></div></td>
</tr>
<tr>
<td><div><input type="checkbox" id="bi04" class="inb"><label for="bi04"></label></div></td>
<td><div><input type="checkbox" id="bi14" class="inb"><label for="bi14"></label></div></td>
<td><div><input type="checkbox" id="bi24" class="inb"><label for="bi24"></label></div></td>
<td><div><input type="checkbox" id="bi34" class="inb"><label for="bi34"></label></div></td>
<td><div><input type="checkbox" id="bi44" class="inb"><label for="bi44"></label></div></td>
</tr>
<tr>
<td><div><input type="checkbox" id="bi05" class="inb"><label for="bi05"></label></div></td>
<td><div><input type="checkbox" id="bi15" class="inb"><label for="bi15"></label></div></td>
<td><div><input type="checkbox" id="bi25" class="inb"><label for="bi25"></label></div></td>
<td><div><input type="checkbox" id="bi35" class="inb"><label for="bi35"></label></div></td>
<td><div><input type="checkbox" id="bi45" class="inb"><label for="bi45"></label></div></td>
</tr>
</table>
</td>

</td><td><center>=</center></td><td>

<table>
<tr>
<td><div id="bo00" class="bo c255"></div></td>
<td><div id="bo10" class="bo c255"></div></td>
<td><div id="bo20" class="bo c255"></div></td>
<td><div id="bo30" class="bo c255"></div></td>
<td><div id="bo40" class="bo c255"></div></td>
</tr>
<tr>
<td><div id="bo01" class="bo c255"></div></td>
<td><div id="bo11" class="bo c255"></div></td>
<td><div id="bo21" class="bo c255"></div></td>
<td><div id="bo31" class="bo c255"></div></td>
<td><div id="bo41" class="bo c255"></div></td>
</tr>
<tr>
<td><div id="bo02" class="bo c255"></div></td>
<td><div id="bo12" class="bo c255"></div></td>
<td><div id="bo22" class="bo c255"></div></td>
<td><div id="bo32" class="bo c255"></div></td>
<td><div id="bo42" class="bo c255"></div></td>
</tr>
<tr>
<td><div id="bo03" class="bo c255"></div></td>
<td><div id="bo13" class="bo c255"></div></td>
<td><div id="bo23" class="bo c255"></div></td>
<td><div id="bo33" class="bo c255"></div></td>
<td><div id="bo43" class="bo c255"></div></td>
</tr>
<tr>
<td><div id="bo04" class="bo c255"></div></td>
<td><div id="bo14" class="bo c255"></div></td>
<td><div id="bo24" class="bo c255"></div></td>
<td><div id="bo34" class="bo c255"></div></td>
<td><div id="bo44" class="bo c255"></div></td>
</tr>
<tr>
<td><div id="bo05" class="bo c255"></div></td>
<td><div id="bo15" class="bo c255"></div></td>
<td><div id="bo25" class="bo c255"></div></td>
<td><div id="bo35" class="bo c255"></div></td>
<td><div id="bo45" class="bo c255"></div></td>
</tr>
</table>
</td>

</td>
</tr>
</table>

<script type="module">
  import init, { check_config, compute_result } from "./mebongo.js";
  init().then(() => {
    // Check whether everything is okay
    let config_okay = check_config(42, 5, 6, 4, 12);
    if (config_okay != 134250805) {
      console.error(`Error ${config_okay}`);
      document.getElementById("output-label").textContent = `Error ${config_okay}`;
      return;
    }
    // Rig up all the buttons:
    for (let tile_index = 0; tile_index < 12; ++tile_index) {
      document.getElementById(`t${tile_index}`).onchange = recompute_output;
    }
    for (let y = 0; y < 6; ++y) {
      for (let x = 0; x < 5; ++x) {
        document.getElementById(`bi${x}${y}`).onchange = recompute_output;
      }
    }
    // Trigger initial update:
    setTimeout(recompute_output, 1);
  });

  const TILE_SIZES = [4, 2, 3, 4, 3, 4, 4, 5, 4, 5, 5, 5];
  // Make this configurable?
  const MAX_STEPS = 10000;

  function explode_row(encoded_row) {
    return [
      Number.parseInt((encoded_row >> 32n) & 0xFFn),
      Number.parseInt((encoded_row >> 24n) & 0xFFn),
      Number.parseInt((encoded_row >> 16n) & 0xFFn),
      Number.parseInt((encoded_row >>  8n) & 0xFFn),
      Number.parseInt((encoded_row >>  0n) & 0xFFn),
    ];
  }

  function recompute_output() {
    let begin = performance.now();
    document.getElementById("output-label").textContent = "Broken";
    document.getElementById("output-label-small").textContent = "lol";

    // Encode tiles
    var tile_total = 0;
    var tile_encoded = 0;
    for (let tile_index = 0; tile_index < 12; ++tile_index) {
      tile_encoded <<= 1;
      if (document.getElementById(`t${tile_index}`).checked) {
        tile_total += TILE_SIZES[tile_index];
        tile_encoded |= 1;
      }
    }
    document.getElementById("input-tiles-label").textContent = `Which tiles? (covers ${tile_total})`;

    // Encode board
    // Note: This assumes that the browser's "integer" type has at least 30 bits.
    // This should be the case with any reasonable int and f64, but is problematic on browsers that use f32.
    // See also https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER
    var board_total = 0;
    var board_encoded = 0;
    for (let y = 5; y >= 0; --y) {
      for (let x = 4; x >= 0; --x) {
        board_encoded <<= 1;
        if (document.getElementById(`bi${x}${y}`).checked) {
          board_total += 1;
          board_encoded |= 1;
        }
      }
    }
    document.getElementById("input-board-label").textContent = `What is the board? (space for ${board_total})`;

    // So the output has to be:
    let result;
    if (board_total >= tile_total) {
      result = compute_result(tile_encoded, board_encoded, MAX_STEPS);
    } else {
      result = {
        steps_taken: 0,
        has_solution: false,
        has_finished: true,
        row0: 1099511627775n,
        row1: 1099511627775n,
        row2: 1099511627775n,
        row3: 1099511627775n,
        row4: 1099511627775n,
        row5: 1099511627775n,
      };
    }
    const cells = [
      explode_row(result.row0),
      explode_row(result.row1),
      explode_row(result.row2),
      explode_row(result.row3),
      explode_row(result.row4),
      explode_row(result.row5),
    ];
    for (let y = 5; y >= 0; --y) {
      for (let x = 4; x >= 0; --x) {
        document.getElementById(`bo${x}${y}`).classList = `bo c${cells[y][x]}`;
      }
    }
    if (result.has_solution) {
      document.getElementById("output-label").textContent = "Solution found!";
      document.getElementById("output-label-small").textContent = `(${result.steps_taken} steps)`;
    } else if (result.has_finished) {
      document.getElementById("output-label").textContent = "No solution exists";
      document.getElementById("output-label-small").textContent = `(proven in ${result.steps_taken} steps)`;
    } else {
      document.getElementById("output-label").textContent = "Timed out";
      document.getElementById("output-label-small").textContent = `(after ${result.steps_taken} steps)`;
    }
    let end = performance.now();
    console.log(begin, end, end - begin);
  }
</script>
</center></body>
</html>
